# Setup

<Warning>
  Enterprise Runner is exclusively available to customers on the [Enterprise tier](https://www.gitpod.io/pricing). If you're an Enterprise customer, contact your Gitpod account manager for more information.
</Warning>

Deploy your Enterprise AWS Runner using our enhanced CloudFormation template with custom ingress capabilities. This comprehensive guide walks you through the complete deployment process using the AWS Management Console.

## Prerequisites

Before starting the deployment, ensure you have:

* **Admin access** to the Gitpod organization
* **AWS Account** with appropriate permissions to create CloudFormation stacks
* **VPC and Subnets** configured in your AWS account
* **SSL/TLS Certificate** provisioned in AWS Certificate Manager (ACM) with both root domain and wildcard subdomain SANs
* **Domain Name** that you control and can modify DNS records for
* **Permissions** to deploy CloudFormation stacks with IAM resources

## Create Enterprise Runner in Gitpod

Go to Settings -> Runners, and press **Setup a new runner**:

<Frame caption="Runners in settings">
  <img src="https://www.gitpod.io/images/docs/flex/runners/runners-settings.webp" />
</Frame>

After choosing AWS from the list of available providers, continue with the **Enterprise Runner template**.

<Frame caption="Provider selection">
  <img src="https://www.gitpod.io/images/docs/flex/runners/runner-providers.webp" />
</Frame>

<Frame caption="CloudFormation Template selection">
  <img src="https://www.gitpod.io/images/docs/flex/runners/aws-template-enterprise.webp" />
</Frame>

Choose the **Enterprise Runner template**, provide a **name** and select the **AWS region** to deploy the Runner into, then press **Create**. This creates the Runner reference in Gitpod.

<Note>
  Runners are regional, and can only launch Environments in the AWS region
  they are deployed in. For multi-region support we recommend setting up
  multiple Runners in different regions. The region cannot be changed once
  deployed.
</Note>

<Frame caption="Add an AWS Runner">
  <img src="https://www.gitpod.io/images/docs/flex/runners/add-runner.webp" />
</Frame>

<Frame caption="Runner details">
  <img src="https://www.gitpod.io/images/docs/flex/runners/runner-details.webp" />
</Frame>

## CloudFormation Template Deployment

Next, ensure you are signed into the right AWS account in the AWS console, and then press **Open AWS CloudFormation** to start deploying the Runner into your AWS account. This will link you to the AWS console to create the CloudFormation stack:

<Frame caption="Create stack in AWS">
  <img src="https://www.gitpod.io/images/docs/flex/runners/create-stack-in-aws.png" />
</Frame>

Most parameters are auto-filled already. The template is organized into several parameter groups and has to be filled out carefully.

#### Gitpod Configuration

Core authentication and API connection settings for your Gitpod Runner.

| Parameter          | Description                                                        | Required |
| ------------------ | ------------------------------------------------------------------ | -------- |
| **Runner ID**      | Unique identifier for your Runner (auto-generated by Gitpod)       | ✅ Yes    |
| **Exchange Token** | Authentication token for the EC2 Runner (auto-generated by Gitpod) | ✅ Yes    |
| **API Endpoint**   | URL of the Gitpod API (auto-generated by Gitpod)                   | ✅ Yes    |

⚠️ **Important**: These values are automatically generated by Gitpod when you create a Runner configuration. Do not modify these values manually.

#### Network Configuration (Mandatory)

VPC and subnet settings for deploying the Runner infrastructure.

| Parameter                | Description                                                                                                    | Example Value                  | Required |
| ------------------------ | -------------------------------------------------------------------------------------------------------------- | ------------------------------ | -------- |
| **VPC**                  | The VPC where the Runner will be deployed                                                                      | `vpc-12345abcd`                | ✅ Yes    |
| **Availability Zones**   | AZs for high availability (select 2-3)                                                                         | `us-east-1a, us-east-1b`       | ✅ Yes    |
| **EC2 Instances Subnet** | Private subnets for EC2 instances (can be non-routable from internal network). Should match the number of AZs  | `subnet-123abc, subnet-456def` | ✅ Yes    |
| **Loadbalance Subnets**  | Subnets for load balancer with CIDR ranges routable from your internal network. Should match the number of AZs | `subnet-123abc, subnet-456def` | ✅ Yes    |

**Recommendations:**

* Select 2-3 Availability Zones for high availability
* **EC2 subnets**: Use private subnets, must be sufficiently large for your expected workload
* **Load balancer subnets**: Must have CIDR ranges routable from your internal network for user access
* Ensure connectivity from user locations via VPN, Direct Connect, or Transit Gateway

#### Network Configuration (Optional)

Configure additional network settings for enterprise security requirements.

| Parameter                                   | Description                                                       | Example Value                     | Required                        |
| ------------------------------------------- | ----------------------------------------------------------------- | --------------------------------- | ------------------------------- |
| **Custom Security Group for Load Balancer** | Security group to attach to the load balancer for traffic control | `sg-abcdef123`                    | ❌ Optional                      |
| **HTTP Proxy**                              | HTTP proxy server URL                                             | `http://proxy.company.com:8080`   | ❌ Optional                      |
| **HTTPS Proxy**                             | HTTPS proxy server URL                                            | `https://proxy.company.com:8080`  | ❌ Optional                      |
| **No Proxy**                                | Comma-separated list of hosts to bypass proxy                     | `.internal,169.254.0.0/16,...`    | ⚠️ Required if proxy configured |
| **Custom CA Certificate**                   | Custom certificate authority from SSM/Secrets Manager             | `{{resolve:ssm:/gitpod/ca-cert}}` | ❌ Optional                      |

**Security Group Behavior:**

* **If not provided**: An automatic security group will be created that allows all traffic (0.0.0.0/0) to ports 80 and 443
* **If provided**: You can specify a custom security group to narrow down the allowed traffic sources for enhanced security

**Proxy Configuration:**

When configuring HTTP/HTTPS proxy, NO\_PROXY must include: `.internal`, `169.254.0.0/16`, `app.gitpod.io`, and `.amazonaws.com`.

**Proxy Update Behavior:**

* **Runner infrastructure**: Changes take effect immediately after CloudFormation update
* **Component-specific timing**:
  * Content initialization: Effective after environment restart
  * Devcontainer: Effective after rebuild
  * Docker in Docker: Effective after container recreation

**Custom CA Certificate:**

Use CloudFormation dynamic references to retrieve certificates from AWS SSM Parameter Store or Secrets Manager. For syntax details, see [SSM Parameter Store](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/dynamic-references-ssm.html) or [Secrets Manager](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/dynamic-references-secretsmanager.html) documentation.

<Warning>
  Custom CA certificates work in runner, content init (SCM), and docker pull operations. However, they are **not supported** in devcontainer and devcontainer image build phases - you must add CA certificates to your images for these use cases.
</Warning>

#### DNS Configuration

Domain name, SSL certificate, and load balancer visibility settings.

| Parameter                    | Description                                    | Example Value                                              | Required |
| ---------------------------- | ---------------------------------------------- | ---------------------------------------------------------- | -------- |
| **Load Balancer Visibility** | Choose between `internal` or `internet-facing` | `internal`                                                 | ✅ Yes    |
| **Domain Name**              | Your domain name for Gitpod access             | `yourdomain.com`                                           | ✅ Yes    |
| **Certificate ARN**          | ARN of your SSL certificate from ACM           | `arn:aws:acm:us-east-1:123456789012:certificate/abc123...` | ✅ Yes    |

**Load Balancer Visibility Options:**

* **internal**: Load balancer is only accessible from within your VPC (recommended for private deployments)
* **internet-facing**: Load balancer is accessible from the internet (only if using public subnets)

## Review and Deploy

1. **Review Configuration**
   * Verify all parameters are correctly set
   * Review the resource summary
2. **Acknowledge Capabilities**
   * Check the box acknowledging that CloudFormation will create IAM resources
   * This is required for the stack to create necessary service roles
3. **Create Stack**
   * Click "Create stack" to begin deployment
   * Monitor the deployment progress in the Events tab

<Info>The CloudFormation stack deployment typically takes 20-25 minutes.</Info>

## Monitoring Deployment

1. **Stack Status**
   * Monitor the stack status on the CloudFormation dashboard
   * Any errors will be displayed in the Events tab
2. **Event Monitoring**
   * Click on the "Events" tab to see real-time deployment progress

## Post-Deployment DNS Configuration

### Retrieve Load Balancer DNS Name

After successful deployment:

1. **Navigate to Outputs Tab**
   * Click on your stack name
   * Go to the "Outputs" tab
2. **Locate DNS Names**
   * Find the output value: **LoadBalancerDNS**: `internal-LoadBa-XXXXX-123456789.us-east-1.elb.amazonaws.com`

### Configure DNS Records

Create DNS records in your domain registry or DNS provider for the **exact domain name** you specified in the CloudFormation parameters.

#### AWS Route 53

If you're using AWS Route 53 to manage your domain, use **alias records** for the most AWS-native configuration:

1. **Navigate to Route 53 Console**
   * Open the [AWS Route 53 Console](https://console.aws.amazon.com/route53/)
   * Select your hosted zone

2. **Create Alias Records**
   * Click "Create record"
   * **Toggle the Alias switch** to enable alias functionality
   * Configure the following records:

| Type  | Name               | Alias Target                                                                             |
| ----- | ------------------ | ---------------------------------------------------------------------------------------- |
| **A** | `yourdomain.com`   | Select "Alias to Network Load Balancer" → Choose your region → Select your load balancer |
| **A** | `*.yourdomain.com` | Select "Alias to Network Load Balancer" → Choose your region → Select your load balancer |

<Frame caption="Route 53 Create Alias Records for Network Load Balancer">
  <img src="https://www.gitpod.io/images/docs/flex/runners/route53-dns-records.jpg" />
</Frame>

**Advantages of Route 53 Alias Records:**

* No additional charges for alias queries
* Automatic health checking
* Better performance with shorter resolution times
* AWS-native integration with load balancers

#### Standard DNS Providers (CNAME Records)

For other DNS providers or if you prefer CNAME records:

| Type  | Name               | Value                                                         | TTL |
| ----- | ------------------ | ------------------------------------------------------------- | --- |
| CNAME | `yourdomain.com`   | `internal-LoadBa-XXXXX-123456789.us-east-1.elb.amazonaws.com` | 300 |
| CNAME | `*.yourdomain.com` | `internal-LoadBa-XXXXX-123456789.us-east-1.elb.amazonaws.com` | 300 |

**Example DNS Configuration:**

If you entered `yourdomain.com` as your domain name parameter, configure:

```
yourdomain.com.     CNAME   internal-LoadBa-XXXXX-123456789.us-east-1.elb.amazonaws.com.
*.yourdomain.com.   CNAME   internal-LoadBa-XXXXX-123456789.us-east-1.elb.amazonaws.com.
```

<Note>
  ⚠️ **Important**: Replace `yourdomain.com` with the exact domain name you entered in the CloudFormation parameters.
</Note>

* DNS changes typically propagate within 5-60 minutes
* You can verify DNS resolution using tools like `nslookup` or `dig`
* Test both the root domain and a wildcard subdomain

## Verification and Testing

1. **Internal Network Test**
   * Verify that the load balancer is accessible from within your VPC
   * Test from an EC2 instance in the same VPC: `curl -k https://yourdomain.com/_health`
2. **DNS Resolution Test**
   ```bash
   nslookup yourdomain.com
   nslookup test.yourdomain.com
   ```

## Important Stack Outputs

After deployment, the following outputs provide important information for integration:

| Output Name                   | Description                    | Usage                                          |
| ----------------------------- | ------------------------------ | ---------------------------------------------- |
| **LoadBalancerDNS**           | Network Load Balancer DNS name | Point your DNS records here                    |
| **EnvironmentRoleArn**        | EC2 Environment Role ARN       | Used by Gitpod Environments for all operations |
| **InstanceProfileNameOutput** | EC2 Instance Profile           | Attached to Runner EC2 instances               |

## Private VPC Endpoints (Optional)

For enhanced security, you can connect to Gitpod's management plane using AWS PrivateLink instead of traversing the public internet.

<Info>
  **Cost consideration**: VPC endpoints incur additional AWS charges (\~\$7.20/month per endpoint per AZ plus data processing fees). See [AWS PrivateLink pricing](https://aws.amazon.com/privatelink/pricing/) for details.
</Info>

### Creating the VPC Endpoint

Create an Interface VPC Endpoint to connect privately to Gitpod's management plane.

<Note>
  **Before you begin**: You'll need your VPC ID, subnet IDs, and security group ID. You can find these in the AWS VPC Console or from your CloudFormation stack outputs.

  **Important**: Your VPC must have both **DNS hostnames** and **DNS resolution** enabled for private DNS names to work properly. You can check and enable these in the VPC Console under Actions → Edit VPC settings.
</Note>

#### Using AWS CLI

```bash
# Replace vpc-xxx, subnet-xxx, and sg-xxx with your actual IDs
aws ec2 create-vpc-endpoint \
    --vpc-id vpc-xxx \
    --service-name com.amazonaws.vpce.us-east-1.vpce-svc-08de744d433e60ff2 \
    --vpc-endpoint-type Interface \
    --subnet-ids subnet-xxx subnet-xxx \
    --security-group-ids sg-xxx \
    --private-dns-enabled \
    --service-region us-east-1
```

For more CLI options and examples, see the [AWS CLI reference for create-vpc-endpoint](https://docs.aws.amazon.com/cli/latest/reference/ec2/create-vpc-endpoint.html).

#### Using AWS PowerShell

```powershell
# Replace vpc-xxx, subnet-xxx, and sg-xxx with your actual IDs
New-EC2VpcEndpoint `
    -VpcId "vpc-xxx" `
    -ServiceName "com.amazonaws.vpce.us-east-1.vpce-svc-08de744d433e60ff2" `
    -VpcEndpointType "Interface" `
    -SubnetId @("subnet-xxx", "subnet-xxx") `
    -SecurityGroupId @("sg-xxx") `
    -PrivateDnsEnabled $true `
    -ServiceRegion "us-east-1"
```

For more PowerShell options and examples, see the [AWS PowerShell reference for New-EC2VpcEndpoint](https://docs.aws.amazon.com/powershell/v4/reference/items/New-EC2VpcEndpoint.html).

#### Using AWS Management Console

1. **Navigate to VPC Console**
   * Open the [AWS VPC Console](https://console.aws.amazon.com/vpc)
   * Select "Endpoints" from the left navigation

2. **Create Endpoint**
   * Click "Create endpoint"
   * **Name tag** (optional): Enter a descriptive name like `gitpod-management-plane`
   * **Service type**: Select "Endpoint services that use NLBs and GWLBs"

3. **Service Settings**
   * **Service name**: Enter `com.amazonaws.vpce.us-east-1.vpce-svc-08de744d433e60ff2`
   * **Enable Cross Region endpoint**: Check this box to connect across regions
   * **Region**: Select us-east-1 as the region
   * Click "Verify service" to confirm the service is available

<Frame caption="VPC Endpoint Service Settings - Enable Cross Region Support">
  <img src="https://www.gitpod.io/images/docs/flex/runners/vpc-endpoint-service-settings.png" />
</Frame>

4. **Network Settings**
   * **VPC**: Select the same VPC where your runner is deployed
   * **Subnets**: Choose private subnets
   * **Security groups**: Select or create a security group that allows HTTPS traffic (port 443)
   * **Enable DNS name**: Check this box to enable private DNS names (this allows `app.gitpod.io` to resolve to the endpoint)

<Frame caption="VPC Endpoint Network Settings - Enable DNS Names">
  <img src="https://www.gitpod.io/images/docs/flex/runners/vpc-endpoint-network-settings.png" />
</Frame>

5. **Create and Verify**
   * Click "Create endpoint"
   * Wait for the endpoint status to become "Available"

For detailed console instructions, see the [AWS documentation on creating interface endpoints](https://docs.aws.amazon.com/vpc/latest/privatelink/create-interface-endpoint.html).

### Security Group Configuration

Your VPC endpoint security group needs these rules:

**Inbound Rules:**

* **Type**: HTTPS (443)
* **Source**: Your runner subnets CIDR or the security group attached to your runner instances
* **Description**: Allow runner access to Gitpod management plane

**Outbound Rules:**

* **Type**: All traffic
* **Destination**: 0.0.0.0/0 (or keep the default outbound rule)

### Verification

After creating the VPC endpoint:

1. **Check endpoint status** in the VPC console
2. **Verify private DNS resolution in your VPC**:
   ```bash
   nslookup app.gitpod.io
   ```
   This should resolve to private IP addresses within your VPC
3. **Confirm private connectivity in Gitpod dashboard**:
   * Navigate to Settings → Runners in your Gitpod dashboard
   * Check your runner details - the **Connection type** should show as "Private"

<Frame caption="Runner Dashboard showing Private Connection Type">
  <img src="https://www.gitpod.io/images/docs/flex/runners/vpc-endpoint-private.png" />
</Frame>

<Note>
  With private DNS enabled, `app.gitpod.io` will automatically resolve to your VPC endpoint's private IP addresses, providing seamless private connectivity.
</Note>

For more information on VPC endpoints concepts and architecture, see the [AWS PrivateLink documentation](https://docs.aws.amazon.com/vpc/latest/privatelink/concepts.html).

## Next Steps

Once your Enterprise Runner is deployed, configure your [repository access](/gitpod/runners/aws/configuring-repository-access) and [Environment classes](/gitpod/runners/aws/environment-classes).

<CardGroup cols={2}>
  <Card title="Configure Repository Access" icon="git" href="/gitpod/runners/aws/configuring-repository-access">
    Set up access to your repositories
  </Card>

  <Card title="Troubleshoot" icon="wrench" href="/gitpod/runners/aws/troubleshooting-runners">
    Resolve common issues including networking problems and Runner configuration
  </Card>
</CardGroup>
